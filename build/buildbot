#!/bin/sh
set -e

usage() {
  echo "Usage: $0 (make|ocb|ocamlbuild) (win (mingw|msvc|msvc64) | <configure-arg>*)"
  exit 1
}

mode=$1
shift 1

case "$mode" in
  make|ocb|ocamlbuild) : ;;
  *) usage;;
esac

case "$1" in
  win)
    opt_win=win
    opt_win2=$2
    shift 2
    Makefile=Makefile.nt;;
  *) Makefile=Makefile;;
esac

set -x

[ -f config/Makefile ] && make -f $Makefile clean

./build/distclean.sh

cvs -q up -dP -r release310

case "$opt_win" in
win)

  # FIXME
  sed -e 's/\(OTHERLIBRARIES=.*\) labltk/\1/' \
    < "config/Makefile.$opt_win2" > config/Makefile

  cp config/m-nt.h config/m.h
  cp config/s-nt.h config/s.h
  ;;

*)
  ./configure --prefix `pwd`/_install $@
  ;;
esac

case "$mode" in
  make)
    make -f $Makefile world opt opt.opt install
    ;;
  ocb|ocamlbuild)
    ./build/fastworld.sh
    ./build/install.sh
    ;;
esac
